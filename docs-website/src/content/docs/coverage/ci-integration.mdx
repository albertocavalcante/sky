---
title: CI Integration
description: Integrate Starlark coverage with CI systems
---

import { Tabs, TabItem, Aside } from '@astrojs/starlight/components';

# CI Integration

Integrate Starlark code coverage into your CI/CD pipeline.

## GitHub Actions

### Basic Coverage

```yaml
name: Test with Coverage

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Install Sky
        run: go install github.com/albertocavalcante/sky/cmd/sky@latest

      - name: Run tests with coverage
        run: |
          skytest --coverage tests/
          skycov --format=cobertura coverage.json > coverage.xml

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: coverage.xml
          fail_ci_if_error: true
```

### Coverage with Thresholds

```yaml
      - name: Check coverage threshold
        run: |
          skycov --min-coverage=80 coverage.json || {
            echo "Coverage below 80%"
            exit 1
          }
```

### Coverage Comment on PRs

```yaml
      - name: Coverage Report
        uses: irongut/CodeCoverageSummary@v1.3.0
        with:
          filename: coverage.xml
          badge: true
          format: markdown
          output: both

      - name: Add Coverage PR Comment
        uses: marocchino/sticky-pull-request-comment@v2
        if: github.event_name == 'pull_request'
        with:
          recreate: true
          path: code-coverage-results.md
```

## GitLab CI

### Basic Coverage

```yaml
stages:
  - test

test:
  stage: test
  image: golang:1.22
  before_script:
    - go install github.com/albertocavalcante/sky/cmd/sky@latest
  script:
    - skytest --coverage tests/
    - skycov --format=cobertura coverage.json > coverage.xml
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
  coverage: '/Total:\s+\d+\/\d+\s+lines\s+\((\d+\.?\d*)%\)/'
```

### Coverage Visualization

GitLab automatically visualizes Cobertura coverage in merge requests:

```yaml
test:
  script:
    - skytest --coverage tests/
    - skycov --format=cobertura coverage.json > coverage.xml
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
```

## Jenkins

### Declarative Pipeline

```groovy
pipeline {
    agent any

    stages {
        stage('Test') {
            steps {
                sh '''
                    skytest --coverage tests/
                    skycov --format=cobertura coverage.json > coverage.xml
                '''
            }
            post {
                always {
                    cobertura coberturaReportFile: 'coverage.xml'
                }
            }
        }
    }
}
```

### Scripted Pipeline

```groovy
node {
    stage('Test') {
        sh 'skytest --coverage tests/'
        sh 'skycov --format=cobertura coverage.json > coverage.xml'
    }

    stage('Publish Coverage') {
        cobertura coberturaReportFile: 'coverage.xml',
                  onlyStable: false,
                  failNoReports: true,
                  sourceEncoding: 'UTF-8'
    }
}
```

## Azure DevOps

```yaml
trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'

steps:
  - task: GoTool@0
    inputs:
      version: '1.22'

  - script: go install github.com/albertocavalcante/sky/cmd/sky@latest
    displayName: 'Install Sky'

  - script: |
      skytest --coverage tests/
      skycov --format=cobertura coverage.json > coverage.xml
    displayName: 'Run tests with coverage'

  - task: PublishCodeCoverageResults@1
    inputs:
      codeCoverageTool: 'Cobertura'
      summaryFileLocation: '$(System.DefaultWorkingDirectory)/coverage.xml'
```

## CircleCI

```yaml
version: 2.1

jobs:
  test:
    docker:
      - image: cimg/go:1.22
    steps:
      - checkout
      - run:
          name: Install Sky
          command: go install github.com/albertocavalcante/sky/cmd/sky@latest
      - run:
          name: Run tests
          command: |
            skytest --coverage tests/
            skycov --format=cobertura coverage.json > coverage.xml
      - store_artifacts:
          path: coverage.xml
      - codecov/upload:
          file: coverage.xml

orbs:
  codecov: codecov/codecov@3
```

## Codecov Integration

Upload coverage to [Codecov](https://codecov.io) for tracking and PR comments.

### Configuration (codecov.yml)

```yaml
coverage:
  status:
    project:
      default:
        target: 80%
        threshold: 1%
    patch:
      default:
        target: 80%

comment:
  layout: "reach,diff,flags,files"
  behavior: default
```

### Upload in CI

<Tabs>
  <TabItem label="GitHub Actions">
```yaml
- uses: codecov/codecov-action@v4
  with:
    files: coverage.xml
    token: ${{ secrets.CODECOV_TOKEN }}
```
  </TabItem>
  <TabItem label="GitLab CI">
```yaml
- bash <(curl -s https://codecov.io/bash) -f coverage.xml
```
  </TabItem>
  <TabItem label="Generic">
```bash
# Install codecov uploader
curl -Os https://uploader.codecov.io/latest/linux/codecov
chmod +x codecov

# Upload
./codecov -f coverage.xml -t $CODECOV_TOKEN
```
  </TabItem>
</Tabs>

## Coveralls Integration

Upload coverage to [Coveralls](https://coveralls.io).

```yaml
# GitHub Actions
- name: Upload to Coveralls
  uses: coverallsapp/github-action@v2
  with:
    file: coverage.xml
    format: cobertura
```

## Coverage Badges

### Shields.io with Codecov

```markdown
![Coverage](https://codecov.io/gh/user/repo/branch/main/graph/badge.svg)
```

### Dynamic Badge from CI

Generate a badge based on coverage percentage:

```yaml
# GitHub Actions
- name: Generate Badge
  run: |
    COVERAGE=$(skycov --format=json coverage.json | jq -r '.summary.percentage')
    echo "COVERAGE=$COVERAGE" >> $GITHUB_ENV

- name: Update Badge
  uses: schneegans/dynamic-badges-action@v1.6.0
  with:
    auth: ${{ secrets.GIST_TOKEN }}
    gistID: your-gist-id
    filename: coverage.json
    label: coverage
    message: ${{ env.COVERAGE }}%
    color: ${{ env.COVERAGE >= 80 && 'green' || env.COVERAGE >= 60 && 'yellow' || 'red' }}
```

## Best Practices

<Aside type="tip" title="CI Coverage Tips">

1. **Set coverage thresholds** - Use `--min-coverage` to prevent regressions
2. **Track trends** - Use Codecov or Coveralls to track coverage over time
3. **Require coverage on PRs** - Block merging if coverage drops
4. **Exclude generated code** - Use `--exclude` for generated files
5. **Cache Sky installation** - Speed up CI by caching the Go binary

</Aside>

### Caching Sky Installation

<Tabs>
  <TabItem label="GitHub Actions">
```yaml
- uses: actions/cache@v4
  with:
    path: ~/go/bin/sky
    key: ${{ runner.os }}-sky-${{ hashFiles('go.sum') }}
```
  </TabItem>
  <TabItem label="GitLab CI">
```yaml
cache:
  paths:
    - /go/bin/sky
```
  </TabItem>
</Tabs>
